name: Deploy to EC2

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã®ã¿å®Ÿè¡Œã•ã‚Œã¾ã™
# PRã®ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯ã¯ci.ymlã§å®Ÿè¡Œã•ã‚Œã¾ã™

on:
  push:
    branches:
      - main  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushï¼ˆãƒãƒ¼ã‚¸ï¼‰æ™‚ã«æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«çµ‚äº†

          echo "ğŸ“ SSHãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆä¸­..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "ğŸ”‘ SSHç§˜å¯†éµã‚’è¨­å®šä¸­..."
          echo "$EC2_KEY" > private_key.pem
          chmod 600 private_key.pem

          echo "ğŸ” ç§˜å¯†éµã®ç¢ºèªï¼ˆæœ€åˆã®2è¡Œï¼‰..."
          head -n 2 private_key.pem || echo "âš ï¸ ç§˜å¯†éµã®èª­ã¿å–ã‚Šã«å¤±æ•—"

          echo "ğŸŒ EC2ãƒ›ã‚¹ãƒˆã‚’known_hostsã«è¿½åŠ ä¸­: $EC2_HOST"
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>&1 || {
            echo "âŒ ssh-keyscanãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo "ãƒ›ã‚¹ãƒˆã«åˆ°é”ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            exit 1
          }

          echo "âœ… known_hostsè¿½åŠ å®Œäº†"

          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªä¸­..."
          ls -lah dist/ || {
            echo "âŒ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          }

          echo "ğŸš€ EC2ã¸ã®è»¢é€ã‚’é–‹å§‹: $EC2_USER@$EC2_HOST:$DEPLOY_PATH"
          scp -v -i private_key.pem -o StrictHostKeyChecking=no -r dist/* $EC2_USER@$EC2_HOST:$DEPLOY_PATH 2>&1 || {
            echo "âŒ SCPã§ã®è»¢é€ãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo "è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :"
            echo "  - EC2ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã§SSHï¼ˆãƒãƒ¼ãƒˆ22ï¼‰ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„"
            echo "  - DEPLOY_PATHãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯æ¨©é™ãŒãªã„"
            echo "  - SSHç§˜å¯†éµã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ããªã„"
            exit 1
          }

          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"

          # ç§˜å¯†éµã‚’å‰Šé™¤
          rm -f private_key.pem

      - name: Restart web server (optional)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # SSHç§˜å¯†éµã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$EC2_KEY" > private_key.pem
          chmod 600 private_key.pem

          # Nginxã®å†èµ·å‹•ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤ï¼‰
          # ssh -i private_key.pem $EC2_USER@$EC2_HOST "sudo systemctl restart nginx"

          # ç§˜å¯†éµã‚’å‰Šé™¤
          rm -f private_key.pem
